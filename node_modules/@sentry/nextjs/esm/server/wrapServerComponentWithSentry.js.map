{"version":3,"file":"wrapServerComponentWithSentry.js","sources":["../../../src/server/wrapServerComponentWithSentry.ts"],"sourcesContent":["import { captureException, getCurrentHub, startTransaction } from '@sentry/core';\nimport { baggageHeaderToDynamicSamplingContext, extractTraceparentData } from '@sentry/utils';\nimport * as domain from 'domain';\n\nimport type { ServerComponentContext } from '../common/types';\n\n/**\n * Wraps an `app` directory server component with Sentry error instrumentation.\n */\nexport function wrapServerComponentWithSentry<F extends (...args: any[]) => any>(\n  appDirComponent: F,\n  context: ServerComponentContext,\n): F {\n  const { componentRoute, componentType } = context;\n\n  // Even though users may define server components as async functions, for the client bundles\n  // Next.js will turn them into synchronous functions and it will transform any `await`s into instances of the `use`\n  // hook. ðŸ¤¯\n  return new Proxy(appDirComponent, {\n    apply: (originalFunction, thisArg, args) => {\n      return domain.create().bind(() => {\n        let maybePromiseResult;\n\n        const traceparentData = context.sentryTraceHeader\n          ? extractTraceparentData(context.sentryTraceHeader)\n          : undefined;\n\n        const dynamicSamplingContext = baggageHeaderToDynamicSamplingContext(context.baggageHeader);\n\n        const transaction = startTransaction({\n          op: 'function.nextjs',\n          name: `${componentType} Server Component (${componentRoute})`,\n          status: 'ok',\n          ...traceparentData,\n          metadata: {\n            source: 'component',\n            dynamicSamplingContext: traceparentData && !dynamicSamplingContext ? {} : dynamicSamplingContext,\n          },\n        });\n\n        const currentScope = getCurrentHub().getScope();\n        if (currentScope) {\n          currentScope.setSpan(transaction);\n        }\n\n        try {\n          maybePromiseResult = originalFunction.apply(thisArg, args);\n        } catch (e) {\n          transaction.setStatus('internal_error');\n          captureException(e);\n          transaction.finish();\n          throw e;\n        }\n\n        if (typeof maybePromiseResult === 'object' && maybePromiseResult !== null && 'then' in maybePromiseResult) {\n          // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n          return maybePromiseResult.then(\n            (res: unknown) => {\n              transaction.finish();\n              return res;\n            },\n            (e: Error) => {\n              transaction.setStatus('internal_error');\n              captureException(e);\n              transaction.finish();\n              throw e;\n            },\n          );\n        } else {\n          transaction.finish();\n          return maybePromiseResult;\n        }\n      })();\n    },\n  });\n}\n"],"names":[],"mappings":";;;;AAMA;AACA;AACA;AACA,SAAA,6BAAA;AACA,EAAA,eAAA;AACA,EAAA,OAAA;AACA,EAAA;AACA,EAAA,MAAA,EAAA,cAAA,EAAA,aAAA,EAAA,GAAA,OAAA,CAAA;AACA;AACA;AACA;AACA;AACA,EAAA,OAAA,IAAA,KAAA,CAAA,eAAA,EAAA;AACA,IAAA,KAAA,EAAA,CAAA,gBAAA,EAAA,OAAA,EAAA,IAAA,KAAA;AACA,MAAA,OAAA,MAAA,CAAA,MAAA,EAAA,CAAA,IAAA,CAAA,MAAA;AACA,QAAA,IAAA,kBAAA,CAAA;AACA;AACA,QAAA,MAAA,eAAA,GAAA,OAAA,CAAA,iBAAA;AACA,YAAA,sBAAA,CAAA,OAAA,CAAA,iBAAA,CAAA;AACA,YAAA,SAAA,CAAA;AACA;AACA,QAAA,MAAA,sBAAA,GAAA,qCAAA,CAAA,OAAA,CAAA,aAAA,CAAA,CAAA;AACA;AACA,QAAA,MAAA,WAAA,GAAA,gBAAA,CAAA;AACA,UAAA,EAAA,EAAA,iBAAA;AACA,UAAA,IAAA,EAAA,CAAA,EAAA,aAAA,CAAA,mBAAA,EAAA,cAAA,CAAA,CAAA,CAAA;AACA,UAAA,MAAA,EAAA,IAAA;AACA,UAAA,GAAA,eAAA;AACA,UAAA,QAAA,EAAA;AACA,YAAA,MAAA,EAAA,WAAA;AACA,YAAA,sBAAA,EAAA,eAAA,IAAA,CAAA,sBAAA,GAAA,EAAA,GAAA,sBAAA;AACA,WAAA;AACA,SAAA,CAAA,CAAA;AACA;AACA,QAAA,MAAA,YAAA,GAAA,aAAA,EAAA,CAAA,QAAA,EAAA,CAAA;AACA,QAAA,IAAA,YAAA,EAAA;AACA,UAAA,YAAA,CAAA,OAAA,CAAA,WAAA,CAAA,CAAA;AACA,SAAA;AACA;AACA,QAAA,IAAA;AACA,UAAA,kBAAA,GAAA,gBAAA,CAAA,KAAA,CAAA,OAAA,EAAA,IAAA,CAAA,CAAA;AACA,SAAA,CAAA,OAAA,CAAA,EAAA;AACA,UAAA,WAAA,CAAA,SAAA,CAAA,gBAAA,CAAA,CAAA;AACA,UAAA,gBAAA,CAAA,CAAA,CAAA,CAAA;AACA,UAAA,WAAA,CAAA,MAAA,EAAA,CAAA;AACA,UAAA,MAAA,CAAA,CAAA;AACA,SAAA;AACA;AACA,QAAA,IAAA,OAAA,kBAAA,KAAA,QAAA,IAAA,kBAAA,KAAA,IAAA,IAAA,MAAA,IAAA,kBAAA,EAAA;AACA;AACA,UAAA,OAAA,kBAAA,CAAA,IAAA;AACA,YAAA,CAAA,GAAA,KAAA;AACA,cAAA,WAAA,CAAA,MAAA,EAAA,CAAA;AACA,cAAA,OAAA,GAAA,CAAA;AACA,aAAA;AACA,YAAA,CAAA,CAAA,KAAA;AACA,cAAA,WAAA,CAAA,SAAA,CAAA,gBAAA,CAAA,CAAA;AACA,cAAA,gBAAA,CAAA,CAAA,CAAA,CAAA;AACA,cAAA,WAAA,CAAA,MAAA,EAAA,CAAA;AACA,cAAA,MAAA,CAAA,CAAA;AACA,aAAA;AACA,WAAA,CAAA;AACA,SAAA,MAAA;AACA,UAAA,WAAA,CAAA,MAAA,EAAA,CAAA;AACA,UAAA,OAAA,kBAAA,CAAA;AACA,SAAA;AACA,OAAA,CAAA,EAAA,CAAA;AACA,KAAA;AACA,GAAA,CAAA,CAAA;AACA;;;;"}